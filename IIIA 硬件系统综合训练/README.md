# RISC-V 5 段流水线 CPU 的设计
## 1 简单计算机系统的设计目标
本课程设计的总体目标是利用 FPGA 以及相关外围器件，设计五段流水 CPU，
要求所设计的流水 CPU 系统能支持自动和单步运行方式，能正确地执行存放在主存
中的程序的功能，对主要的数据流和控制流通过 LED、数码管等适时的进行显示，
方便监控和调试。尽可能利用 EDA 软件或仿真软件对模型机系统中各部件进行仿真
分析和功能验证。在学有余力的前提下，可进一步扩展相关功能。
## 2 主要技术指标
1) 支持规定的 32 位 RISC-V 指令集（指令集任选），具体见表 1；
2) 在 CCAB 扩展指令集中支持 2 条 C 类运算指令，1 条 M 类存储指令，1
条 B 类分支指令，具体任务每位同学不一样，指令编号详见见公文包中的任务分配；
3) 支持多级嵌套中断，利用中断触发扩展指令集测试程序；
4) 支持 5 段流水机制，可处理数据冒险、结构冒险、分支冒险；
5) 能运行由自己所设计的指令系统构成的一段测试程序，测试程序应能涵盖所有指令，程序执行功能正确。
6) 能运行教师提供的标准测试程序，并自动统计执行周期数
7) 能自动统计各类无条件分支指令数目，条件分支成功次数、插入气泡数目、
load-use 冲突次数、动态分支预测流水线能自动统计预测成功与失败次数。

### 表 1 基本指令集

| #   | RISC-V 指令类型 | 简单功能描述       | 备注                                                                 |
|-----|----------------|--------------------|----------------------------------------------------------------------|
| 1   | ADD            | 加法               | 指令格式与功能请参考 RISC-V32 指令集英文手册，或参考 RARS 模拟器|
| 2   | ADDI           | 立即数加           |                                                                      |
| 3   | AND            | 与                 |                                                                      |
| 4   | ANDI           | 立即数与           |                                                                      |
| 5   | SLLI           | 逻辑左移           |                                                                      |
| 6   | SRAI           | 算数右移           |                                                                      |
| 7   | SRLI           | 逻辑右移           |                                                                      |
| 8   | SUB            | 减                 |                                                                      |
| 9   | OR             | 或                 |                                                                      |
| 10  | ORI            | 立即数或           |                                                                      |
| 11  | XORI           | 或非/立即数异或    |                                                                      |
| 12  | LW             | 加载字             |                                                                      |
| 13  | SW             | 存字               |                                                                      |
| 14  | BEQ            | 相等跳转           |                                                                      |
| 15  | BNE            | 不相等跳转         |                                                                      |
| 16  | SLT            | 小于置数           |                                                                      |
| 17  | SLTI           | 小于立即数置数     |                                                                      |
| 18  | SLTU           | 小于无符号数置数   |                                                                      |
| 19  | JAL            | 转移并链接         |                                                                      |
| 20  | JALR           | 转移到指定寄存器   |                                                                      |
| 21  | ECALL          | 系统调用           | if ($a7==34) LED 输出$a0 的值；else 停机等待 Go 按键按下。注意显示逻辑需要考虑如何锁存过去的数据，否则数据一闪而过。<font color=Crimson>**a7即0x11寄存器，a0即0xa寄存器**</font>  |
| 22  | CSRRSI         | 访问 CSR 寄存器    | 中断相关，可简化为开中断|
| 23  | CSRRCI         | 访问 CSR 寄存器    | 中断相关，可简化为关中断|
| 24  | URET           | 中断返回           | 清中断，mEPC 送 PC，开中断|

### 表 2 CCAB 扩展指令集

| 指令分类   | 编号 | RISC-V 指令类型 | 备注                                                         |
|------------|------|----------------|--------------------------------------------------------------|
| 运算（C）  | 1    | SLL            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 2    | SRL            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 3    | SRA            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 4    | XOR            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 5    | AUIPC          | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 6    | LUI            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 7    | SLTIU          | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 8    | MUL            | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | 9    | DIVU           | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 运算（C）  | A    | REMU           | 指令格式参考 RISC-V32 指令集，最终功能以 RARS 模拟器为准。 |
| 存储访问（A） | 1    | LB             |                                                              |
| 存储访问（A） | 2    | LBU            |                                                              |
| 存储访问（A） | 3    | LH             |                                                              |
| 存储访问（A） | 4    | LHU            |                                                              |
| 存储访问（A） | 5    | SB             |                                                              |
| 存储访问（A） | 6    | SH             |                                                              |
| 跳转（B）   | 1    | BLT            |                                                              |
| 跳转（B）   | 2    | BGE            |                                                              |
| 跳转（B）   | 3    | BLTU           |                                                              |
| 跳转（B）   | 4    | BGEU           |                                                              |

## 3 系统设计要求
1) 根据课程设计指导书的要求，制定出设计方案；
2) 分析指令系统格式，指令系统功能。
3) 根据指令系统构建基本功能部件，主要数据通路。
4) 根据功能部件及数据通路连接，分析所需要的控制信号以及这些控制信号的有效形式；
5) 设计出实现指令功能的硬布线控制器；
6) 调试、数据分析、验收检查；
7) 课程设计报告和总结。
## 4 课程设计成绩的评定
1) 评定成绩根据考核、课程设计的过程、课程设计的效果、课程设计报告的
质量等几部分组成；
2) 评分标准为设计过程占 70%，团队作业 10%，报告和图纸部分占 20%；
3) 课程设计的成绩评定等级为不及格、及格、中、良好、优秀五级，具体的
评定标准见评分规则；
4) 对基本功能进行扩展或设计具有非常鲜明的特征和一定程度的创新，可根
据实际情况加分。
## 5 对课程设计报告的要求
1) 课程设计报告是体现和总结课程设计成果的载体，主要内容包括：设计题
目、设计目的、设备器材、设计原理及内容、设计步骤、遇到的问题及解
决方法、设计总结、参考文献等。
2) 在适当位置配合相应的实验原理图、数据通路图等图表进行说明。应做到
文理通顺，内容正确完整，书写工整，装订整齐。
3) 设计总结部分主要写本人工作简介以及设计体会，包括通过课程设计学到
了什么，哪里遇到了困难，解决的办法以及今后的目标。
4) 为统一格式和要求，课程设计报告要求采用《硬件综合训练》课程设计报
告模板，采用 A4 纸双面打印（教师不要求提交纸质版除外）。为减轻报
告撰写工作量，关注报告书写质量，报告总页码不允许超过 40 页。
## 6 课程设计时间安排
课程设计的总体时间为 2 周，总体安排如下:
1) 第 1 天：到实验室布置任务和集中讲解，领取开发设备。
2) 第 1~3 天：学生查阅资料，开始方案设计。
3) 第 4 天：中期进度检查，单周期 CPU 验收检查，文档检查。
4) 第 6~10 天：阶段性成果随时检查。
5) 第 10 天：最终结果验收。
6) 10~30 天：团队任务。
验收采用分步检查验收方法，以适合各种层次的学生，不断提高学生动手能
力。验收辅以答辩的方式，抄袭被抄袭均按零分处理。
## 7 项目检查
所有阶段性成果能在头歌上完成检查的一定要在头歌上留下记录，完成你认为
的最终版本后找指导教师进行最后检查，检查后要在纸质检查表上留下记录。
## 8 报告提交
【腾讯文档】https://docs.qq.com/form/page/DYmVrV1ZtZUFSR2xR
